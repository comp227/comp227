name: build and deploy

on:
  push:
    branches:
      - source

permissions:
  contents: write

jobs:
  build:
    name: deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '10.x'

      - name: install
        run: npm install

      - name: build
        run: |
          ls -la
          npm run build

      - name: git status
        run: git status

      - name: working dir
        run: |
          cd public
          pwd
          ls -la
      
      - name: Debug token presence
        shell: bash
        run: |
          if [ -z "${{ secrets.GITHUB_TOKEN }}" ]; then
            echo "GITHUB_TOKEN missing (unexpected)"; exit 1
          fi
          echo "GITHUB_TOKEN exists"

      - name: Debug can GITHUB_TOKEN authenticate to repo?
        shell: bash
        run: |
          set -e
          git ls-remote "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/comp227/comp227.git" > /dev/null
          echo "ls-remote succeeded (token works for HTTPS auth)"

      - name: Gatsby Publish
        uses: enriikke/gatsby-gh-pages-action@v2
        with:
          access-token: ${{ secrets.GITHUB_TOKEN }}
